// File: src\main\java\com\alextheunknowable\musictagger\controller\ArtistController.java
package com.alextheunknowable.musictagger.controller;

import com.alextheunknowable.musictagger.model.Artist;
import com.alextheunknowable.musictagger.service.ArtistService;
import jakarta.validation.Valid;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;

@CrossOrigin
@RestController
@RequestMapping("/artists")
public class ArtistController {
    private final ArtistService artistService;
    public ArtistController(ArtistService artistService) {
        this.artistService = artistService;
    }

    @GetMapping
    public List<Artist> list(@RequestParam(required = false) String name) {
        return artistService.getArtists(name);
    }

    @GetMapping("/{id}")
    public Artist get(@PathVariable int id) {
        return artistService.getArtistById(id);
    }

    @PreAuthorize("isAuthenticated()")
    @PostMapping
    public Artist add(@Valid @RequestBody Artist artist, Principal principal) {
        return artistService.createArtist(artist, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @PutMapping("/{id}")
    public Artist update(@PathVariable int id, @RequestBody Artist artist, Principal principal) {
        return artistService.updateArtist(id, artist, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @DeleteMapping("/{id}")
    public void delete(@PathVariable int id, Principal principal) {
        artistService.deleteArtist(id, principal);
    }
}


// File: src\main\java\com\alextheunknowable\musictagger\controller\AuthenticationController.java
package com.alextheunknowable.musictagger.controller;

import com.alextheunknowable.musictagger.dao.UserDao;
import com.alextheunknowable.musictagger.model.auth.LoginResponseDto;
import com.alextheunknowable.musictagger.security.jwt.TokenProvider;
import com.alextheunknowable.musictagger.model.auth.LoginDto;
import com.alextheunknowable.musictagger.model.auth.RegisterUserDto;
import com.alextheunknowable.musictagger.model.User;
import jakarta.validation.Valid;

import com.alextheunknowable.musictagger.exception.DaoException;
import org.springframework.http.HttpStatus;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.server.ResponseStatusException;

/**
 * AuthenticationController is a class used for handling requests to authenticate Users.
 *
 * It depends on an instance of a UserDao for retrieving and storing user data. This is provided
 * through dependency injection.
 */
@RestController
@CrossOrigin
public class AuthenticationController {

    private final TokenProvider tokenProvider;
    private final AuthenticationManagerBuilder authenticationManagerBuilder;
    private UserDao userDao;

    public AuthenticationController(TokenProvider tokenProvider, AuthenticationManagerBuilder authenticationManagerBuilder, UserDao userDao) {
        this.tokenProvider = tokenProvider;
        this.authenticationManagerBuilder = authenticationManagerBuilder;
        this.userDao = userDao;
    }

    @RequestMapping(path = "/login", method = RequestMethod.POST)
    public LoginResponseDto login(@Valid @RequestBody LoginDto loginDto) {
        try {
            UsernamePasswordAuthenticationToken authenticationToken =
                    new UsernamePasswordAuthenticationToken(loginDto.getUsername(), loginDto.getPassword());

            Authentication authentication = authenticationManagerBuilder.getObject().authenticate(authenticationToken);

            if(authentication.isAuthenticated()){
                String jwt = tokenProvider.createToken(authentication, false);
                User user = userDao.getUserByUsername(loginDto.getUsername());
                return new LoginResponseDto(jwt, user);
            }

            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED);
        }
        catch (DaoException e) {
            throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, "DAO error - " + e.getMessage());
        }
    }

    @ResponseStatus(HttpStatus.CREATED)
    @RequestMapping(path = "/register", method = RequestMethod.POST)
    public User register(@Valid @RequestBody RegisterUserDto newUser) {

        if(!newUser.isPasswordsMatch()){
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "password and confirm password do not match");
        }

        try {
            if (userDao.getUserByUsername(newUser.getUsername()) != null) {
                throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "User already exists.");
            }

            User user = userDao.createUser(new User(newUser.getUsername(), newUser.getPassword(), newUser.getRole()));
            return user;
        }
        catch (DaoException e) {
            throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, "DAO error - " + e.getMessage());
        }
    }

}


// File: src\main\java\com\alextheunknowable\musictagger\controller\LinkController.java
package com.alextheunknowable.musictagger.controller;

import com.alextheunknowable.musictagger.model.Link;
import com.alextheunknowable.musictagger.service.LinkService;
import jakarta.validation.Valid;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;

@CrossOrigin
@RestController
@RequestMapping("/links")
public class LinkController {
    private final LinkService linkService;
    public LinkController(LinkService linkService) {
        this.linkService = linkService;
    }

    @GetMapping
    public List<Link> list() {
        return linkService.getLinks();
    }

    @GetMapping("/{id}")
    public Link get(@PathVariable int id) {
        return linkService.getLinkById(id);
    }

    @PreAuthorize("isAuthenticated()")
    @PostMapping
    public Link add(@Valid @RequestBody Link link, Principal principal) {
        return linkService.createLink(link, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @PutMapping("/{id}")
    public Link update(@PathVariable int id, @RequestBody Link link, Principal principal) {
        return linkService.updateLink(id, link, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @DeleteMapping("/{id}")
    public void delete(@PathVariable int id, Principal principal) {
        linkService.deleteLink(id, principal);
    }
}


// File: src\main\java\com\alextheunknowable\musictagger\controller\SourceController.java
package com.alextheunknowable.musictagger.controller;

import com.alextheunknowable.musictagger.model.Source;
import com.alextheunknowable.musictagger.service.SourceService;
import jakarta.validation.Valid;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;

@CrossOrigin
@RestController
@RequestMapping("/sources")
public class SourceController {
    private final SourceService sourceService;
    public SourceController(SourceService sourceService) {
        this.sourceService = sourceService;
    }

    @GetMapping
    public List<Source> list(@RequestParam(required = false) String name) {
        return sourceService.getSources(name);
    }

    @GetMapping("/{id}")
    public Source get(@PathVariable int id) {
        return sourceService.getSourceById(id);
    }

    @PreAuthorize("isAuthenticated()")
    @PostMapping
    public Source add(@Valid @RequestBody Source source, Principal principal) {
        return sourceService.createSource(source, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @PutMapping("/{id}")
    public Source update(@PathVariable int id, @RequestBody Source source, Principal principal) {
        return sourceService.updateSource(id, source, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @DeleteMapping("/{id}")
    public void delete(@PathVariable int id, Principal principal) {
        sourceService.deleteSource(id, principal);
    }
}


// File: src\main\java\com\alextheunknowable\musictagger\controller\TagController.java
package com.alextheunknowable.musictagger.controller;

import com.alextheunknowable.musictagger.model.Tag;
import com.alextheunknowable.musictagger.service.TagService;
import jakarta.validation.Valid;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;

@CrossOrigin
@RestController
@RequestMapping("/tags")
public class TagController {
    private final TagService tagService;
    public TagController(TagService tagService) {
        this.tagService = tagService;
    }

    @GetMapping
    public List<Tag> list(@RequestParam(required = false) String name) {
        return tagService.getTags(name);
    }

    @GetMapping("/{id}")
    public Tag get(@PathVariable int id) {
        return tagService.getTagById(id);
    }

    @PreAuthorize("isAuthenticated()")
    @PostMapping
    public Tag add(@Valid @RequestBody Tag tag, Principal principal) {
        return tagService.createTag(tag, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @PutMapping("/{id}")
    public Tag update(@PathVariable int id, @RequestBody Tag tag, Principal principal) {
        return tagService.updateTag(id, tag, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @DeleteMapping("/{id}")
    public void delete(@PathVariable int id, Principal principal) {
        tagService.deleteTag(id, principal);
    }
}


// File: src\main\java\com\alextheunknowable\musictagger\controller\TrackController.java
package com.alextheunknowable.musictagger.controller;

import com.alextheunknowable.musictagger.model.Track;
import com.alextheunknowable.musictagger.model.TrackCreationDto;
import com.alextheunknowable.musictagger.model.TrackDto;
import com.alextheunknowable.musictagger.model.TrackSearchCriteria;
import com.alextheunknowable.musictagger.service.TrackService;
import jakarta.validation.Valid;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;
import java.util.List;

@CrossOrigin
@RestController
@RequestMapping("/tracks")
public class TrackController {
    private final TrackService trackService;
    public TrackController(TrackService trackService) {
        this.trackService = trackService;
    }

    @GetMapping
    public List<Track> list(@RequestParam(required = false) TrackSearchCriteria tsc, Principal principal) {
        return trackService.getTracks(tsc, principal);
    }

    @GetMapping("/{id}")
    public Track get(@PathVariable int id) {
        return trackService.getTrackById(id);
    }

    @PreAuthorize("isAuthenticated()")
    @PostMapping
    public TrackDto add(@Valid @RequestBody TrackCreationDto trackCDto, Principal principal) {
        return trackService.createTrack(trackCDto, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @PutMapping("/{id}")
    public Track update(@PathVariable int id, @RequestBody Track track, Principal principal) {
        return trackService.updateTrack(id, track, principal);
    }

    @PreAuthorize("isAuthenticated()")
    @DeleteMapping("/{id}")
    public void delete(@PathVariable int id, Principal principal) {
        trackService.deleteTrack(id, principal);
    }
}


// File: src\main\java\com\alextheunknowable\musictagger\controller\UserController.java
package com.alextheunknowable.musictagger.controller;

import com.alextheunknowable.musictagger.dao.*;
import com.alextheunknowable.musictagger.exception.DaoException;
import com.alextheunknowable.musictagger.model.User;
import org.springframework.http.HttpStatus;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.server.ResponseStatusException;

import java.util.List;

@CrossOrigin
@RestController
@RequestMapping("/users")
@PreAuthorize("hasRole('ADMIN')")
public class UserController {
    private final UserDao userDao;

    public UserController(UserDao userDao) {
        this.userDao = userDao;
    }

    @GetMapping
    public List<User> list() {
        try {
            return userDao.getUsers(); //TODO: replace with service call
        } catch (DaoException e) {
            throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, "could not get cards: " + e.getMessage());
        }
    }

    @GetMapping("/{id}")
    public User get(@PathVariable int id) {
        try {
            return userDao.getUserById(id); //TODO: replace with service call
        } catch (DaoException e) {
            throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, "could not get card: " + e.getMessage());
        }
    }

}


